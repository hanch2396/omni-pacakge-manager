#!/bin/bash

# --- ì„¤ì • ---
CONTAINER_NAME="dpm-arch"             # Distrobox ì»¨í…Œì´ë„ˆ ì´ë¦„
BACKUP_REPO="${CONTAINER_NAME}-backup" # ë°±ì—… ì´ë¯¸ì§€ê°€ ì €ì¥ë  ë ˆí¬ì§€í† ë¦¬ ì´ë¦„
MAX_BACKUPS=5                         # ìœ ì§€í•  ìµœëŒ€ ë°±ì—… ê°œìˆ˜

action=$1

CMD=""
LOG_MSG=""

# ë°±ì—… ì •ë¦¬ í•¨ìˆ˜ (Rotation Logic)
cleanup_old_backups() {
    echo "ğŸ” Checking for old snapshots..."
    
    # 1. í•´ë‹¹ ë ˆí¬ì§€í† ë¦¬ì˜ ì´ë¯¸ì§€ë“¤ì„ ìƒì„± ìµœì‹ ìˆœìœ¼ë¡œ ë‚˜ì—´
    # 2. tail -n +$((MAX_BACKUPS + 1)) : ìƒìœ„ Nê°œë¥¼ ê±´ë„ˆë›°ê³  ê·¸ ì´í›„(ì˜¤ë˜ëœ ê²ƒë“¤)ë§Œ ì¶œë ¥
    # 3. xargs -r podman image rm : ì¶œë ¥ëœ ì˜¤ë˜ëœ ì´ë¯¸ì§€ë“¤ì„ ì‚­ì œ (ëª©ë¡ì´ ì—†ìœ¼ë©´ ì‹¤í–‰ ì•ˆ í•¨)
    
    podman images --sort created --format "{{.Repository}}:{{.Tag}}" \
    | grep "^${BACKUP_REPO}:" \
    | tail -n +$((MAX_BACKUPS + 1)) \
    | xargs -r podman image rm
    
    # ì‚­ì œ ì‘ì—… í›„ ê²°ê³¼ ë©”ì‹œì§€ (ì„ íƒ ì‚¬í•­)
    # ì‚­ì œëœ ì´ë¯¸ì§€ê°€ ì—†ë‹¤ë©´ ìœ„ ëª…ë ¹ì–´ê°€ ì¡°ìš©íˆ ë„˜ì–´ê°‘ë‹ˆë‹¤.
}

# ---------------------------------------------------------
# í•¨ìˆ˜: ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€ì—ì„œ .desktop íŒŒì¼ì„ ì°¾ì•„ ìë™ Export
# ---------------------------------------------------------
auto_export_apps() {
    local pkg_name="$1"
    echo "ğŸ” Checking for GUI applications in '$pkg_name'..."

    # ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ ì‹¤í–‰í•  ìŠ¤í¬ë¦½íŠ¸
    # 1. pacman -Qlq: íŒ¨í‚¤ì§€ê°€ ì„¤ì¹˜í•œ íŒŒì¼ ëª©ë¡ ì¡°íšŒ (Quiet mode)
    # 2. grep: .desktop íŒŒì¼ë§Œ í•„í„°ë§ (/usr/share/applications/ ê²½ë¡œ)
    # 3. while read: ë°œê²¬ëœ íŒŒì¼ë§ˆë‹¤ distrobox-export ì‹¤í–‰
    
    distrobox-enter "$CONTAINER_NAME" -- bash <<EOF
        # íŒ¨í‚¤ì§€ ì´ë¦„ ë³€ìˆ˜ ì„¤ì • (í˜¸ìŠ¤íŠ¸ì˜ $pkg_name ê°’ì´ ì—¬ê¸°ì— ë“¤ì–´ê°)
        TARGET="$pkg_name"
        
        # pacman ì¿¼ë¦¬ ì‹¤í–‰
        pacman -Qlq "\$TARGET" 2>/dev/null | grep -E '^/usr/share/applications/.*\.desktop$' | while read -r file; do
            # íŒŒì¼ì´ ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
            if [ -f "\$file" ]; then
                app=\$(basename "\$file" .desktop)
                echo "ğŸš€ Auto-exporting: \$app"
                distrobox-export --app "\$app"
            fi
        done
EOF
}

if [ "$action" == "init" ]; then
    echo "ğŸ›  Initializing dpm environment..."
    
    # 1. ì•„ì¹˜ ë¦¬ëˆ…ìŠ¤ ì»¨í…Œì´ë„ˆ ìƒì„±
    distrobox-create --name $CONTAINER_NAME --image docker.io/library/archlinux:latest --yes
    
    # 2. ì‹œìŠ¤í…œ ì„¤ì • (ë¡œì¼€ì¼, Multilib, ë³‘ë ¬ ë‹¤ìš´ë¡œë“œ)
    echo "âš™ï¸  Configuring system..."
    
    distrobox-enter arch-dev -- sudo bash <<EOF
        # --- 1) ë¡œì¼€ì¼ ì„¤ì • ---
        sed -i 's/^#en_US.UTF-8 UTF-8/en_US.UTF-8 UTF-8/' /etc/locale.gen
        
        HOST_LANG="$LANG"
        if [ -n "\$HOST_LANG" ]; then
            echo "   -> Detected host locale: \$HOST_LANG"
            CLEAN_LANG=\$(echo "\$HOST_LANG" | sed 's/\./\\\./')
            sed -i "s/^#\$CLEAN_LANG/\$CLEAN_LANG/" /etc/locale.gen
        fi
        
        locale-gen

        # --- 2) Multilib í™œì„±í™” ---
        echo "   -> Enabling multilib repository..."
        sed -i "/\[multilib\]/,/Include/"'s/^#//' /etc/pacman.conf

        # --- 3) ë³‘ë ¬ ë‹¤ìš´ë¡œë“œ í™œì„±í™” (ì†ë„ í–¥ìƒ) ---
        echo "   -> Setting ParallelDownloads to 10..."
        # #ParallelDownloads = 5  <-- ì´ ì¤„ì„ ì°¾ì•„ì„œ ParallelDownloads = 10 ìœ¼ë¡œ ë³€ê²½
        sed -i 's/^#ParallelDownloads.*/ParallelDownloads = 10/' /etc/pacman.conf
EOF

    # 3. ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸ ë° í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜
    # Multilibì´ í™œì„±í™”ë˜ì—ˆìœ¼ë¯€ë¡œ -Syu ì‹¤í–‰ ì‹œ multilib DBë„ í•¨ê»˜ ë™ê¸°í™”ë©ë‹ˆë‹¤.
    echo "ğŸ“¦ Setting up base packages and updating..."
    distrobox-enter arch-dev -- sudo pacman -Syu --noconfirm base-devel git

    # 4. yay ì„¤ì¹˜
    echo "ğŸ“¦ Setting up AUR helper (yay)..."
    distrobox-enter $CONTAINER_NAME -- bash -c "git clone https://aur.archlinux.org/yay-bin.git && cd yay-bin && makepkg -si --noconfirm && cd .. && rm -rf yay-bin"
    
    echo "âœ¨ Initialization complete! You can now use 'dpm install <package>'."
    exit 0
fi

if [ "$action" == "self-update" ]; then
    echo "ğŸ”„ Updating dpm..."
    sudo curl -fsSL https://raw.githubusercontent.com/hanch2396/dpm/main/dpm -o /usr/local/bin/dpm
    sudo chmod +x /usr/local/bin/dpm
    echo "âœ… Updated to the latest version."
    exit 0
fi

shift  # ì²« ë²ˆì§¸ ì¸ì(install, upgrade ë“±)ë¥¼ ëª©ë¡ì—ì„œ ì œê±°
       # ì´ì œë¶€í„° $1, $2... ëŠ” ëª¨ë‘ íŒ¨í‚¤ì§€ ì´ë¦„ì´ ë©ë‹ˆë‹¤. ($@)

if [ "$action" == "install" ]; then
    # ì¸ìê°€ ì—†ìœ¼ë©´ ì—ëŸ¬
    if [ $# -eq 0 ]; then
        echo "âŒ Error: Package name(s) required."
        exit 1
    fi
    
    # $* : ë‚¨ì€ ëª¨ë“  ì¸ìë¥¼ ê³µë°±ìœ¼ë¡œ ì—°ê²° (ì˜ˆ: "pkg1 pkg2 pkg3")
    CMD="yay -S $* --noconfirm"
    LOG_MSG="ğŸ“¦ Installing packages: $*"

elif [ "$action" == "remove" ]; then
     if [ $# -eq 0 ]; then
        echo "âŒ Error: Package name(s) required."
        exit 1
    fi
    CMD="yay -Rns $* --noconfirm"
    LOG_MSG="ğŸ—‘ Removing packages: $*"

elif [ "$action" == "upgrade" ]; then
    # ì‹œìŠ¤í…œ ì „ì²´ ì—…ë°ì´íŠ¸ (Archì˜ í‘œì¤€ ë°©ì‹: -Syu)
    CMD="yay -Syu --noconfirm"
    LOG_MSG="ğŸ”„ Upgrading entire system..."

elif [ "$action" == "enter" ]; then
    # ì‚¬ìš©ë²• 1: dpm enter          (ë‹¨ìˆœ ì…¸ ì§„ì…)
    # ì‚¬ìš©ë²• 2: dpm enter [ëª…ë ¹ì–´] (ì»¨í…Œì´ë„ˆ ì•ˆì—ì„œ íŠ¹ì • ëª…ë ¹ì–´ ì‹¤í–‰)
    
    # "enter"ë¼ëŠ” ì²« ë²ˆì§¸ ì¸ìëŠ” ì²˜ë¦¬í–ˆìœ¼ë¯€ë¡œ ì œê±°(shift)í•©ë‹ˆë‹¤.
    # ì´ì œ "$@"ì—ëŠ” enter ë’¤ì— ì˜¤ëŠ” ë‚˜ë¨¸ì§€ ì¸ìë“¤ë§Œ ë‚¨ìŠµë‹ˆë‹¤.
    shift 

    if [ $# -eq 0 ]; then
        # ì¶”ê°€ ì¸ìê°€ ì—†ìœ¼ë©´ ê·¸ëƒ¥ ì…¸ë¡œ ì§„ì…
        echo "ğŸš€ Entering interactive shell in '$CONTAINER_NAME'..."
        echo "Type 'exit' to return to host."
        distrobox-enter "$CONTAINER_NAME"
    else
        # ì¶”ê°€ ì¸ìê°€ ìˆìœ¼ë©´ í•´ë‹¹ ëª…ë ¹ì–´ë¥¼ ì»¨í…Œì´ë„ˆ ì•ˆì—ì„œ ì‹¤í–‰
        # -- (ëŒ€ì‹œ ë‘ ê°œ)ëŠ” distrobox ì˜µì…˜ê³¼ ì‹¤í–‰í•  ëª…ë ¹ì–´ë¥¼ êµ¬ë¶„í•©ë‹ˆë‹¤.
        echo "ğŸš€ Executing in '$CONTAINER_NAME': $*"
        distrobox-enter "$CONTAINER_NAME" -- "$@"
    fi
    
    # ì‹¤í–‰ í›„ ì¢…ë£Œ ì½”ë“œ ì „ë‹¬
    exit $?

else
    # ê·¸ ì™¸ ëª…ë ¹ì–´(remove, search ë“±)ëŠ” ìŠ¤ëƒ…ìƒ· ì—†ì´ íŒ¨ìŠ¤ìŠ¤ë£¨í•˜ê±°ë‚˜ ë³„ë„ ì²˜ë¦¬
    distrobox-enter "$CONTAINER_NAME" -- yay "$@"
    exit 0
fi

# ---------------------------------------------------------
# ìŠ¤ëƒ…ìƒ· ë° ì‹¤í–‰ ë¡œì§ (installê³¼ upgrade ëª¨ë‘ ì ìš©)
# ---------------------------------------------------------

# 1. ìŠ¤ëƒ…ìƒ· ìƒì„±
TIMESTAMP=$(date +%Y%m%d%H%M%S)
NEW_TAG="${BACKUP_REPO}:${TIMESTAMP}"

echo "ğŸ“¸ Creating snapshot before changes: $NEW_TAG"
podman commit "$CONTAINER_NAME" "$NEW_TAG" > /dev/null

if [ $? -ne 0 ]; then
    echo "âŒ Snapshot failed. Aborting."
    exit 1
fi

# 2. ì˜¤ë˜ëœ ìŠ¤ëƒ…ìƒ· ì •ë¦¬
cleanup_old_backups

# 3. ì‹¤ì œ ëª…ë ¹ì–´ ì‹¤í–‰ (install ë˜ëŠ” upgrade)
echo "$LOG_MSG"
distrobox-enter "$CONTAINER_NAME" -- $CMD

# 4. ê²°ê³¼ í™•ì¸ ë° ë¡¤ë°±
if [ $? -eq 0 ]; then
    echo "âœ… Success!"

    if [ "$action" == "install" ]; then
        # ì…ë ¥ëœ ëª¨ë“  íŒ¨í‚¤ì§€($@)ì— ëŒ€í•´ ë°˜ë³µ ìˆ˜í–‰
        for pkg in "$@"; do
            auto_export_apps "$pkg"
        done
    fi

else
    echo "âš ï¸ Operation failed!"
    echo "ğŸ”„ Rolling back to snapshot ($NEW_TAG)..."
    
    distrobox-stop "$CONTAINER_NAME" --yes
    distrobox-rm "$CONTAINER_NAME" --force
    distrobox-create --name "$CONTAINER_NAME" --image "$NEW_TAG" --yes
    
    echo "âœ… Rollback completed."
fi
