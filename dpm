#!/bin/bash

# --- ì„¤ì • ---
CONTAINER_NAME="dpm-arch"             # Distrobox ì»¨í…Œì´ë„ˆ ì´ë¦„
BACKUP_REPO="${CONTAINER_NAME}-backup" # ë°±ì—… ì´ë¯¸ì§€ê°€ ì €ì¥ë  ë ˆí¬ì§€í† ë¦¬ ì´ë¦„
MAX_BACKUPS=5                         # ìœ ì§€í•  ìµœëŒ€ ë°±ì—… ê°œìˆ˜

action=$1
package=$2

CMD=""
LOG_MSG=""

# ë°±ì—… ì •ë¦¬ í•¨ìˆ˜ (Rotation Logic)
cleanup_old_backups() {
    echo "ğŸ” Checking for old snapshots..."
    
    # 1. í•´ë‹¹ ë ˆí¬ì§€í† ë¦¬ì˜ ì´ë¯¸ì§€ë“¤ì„ ìƒì„± ìµœì‹ ìˆœìœ¼ë¡œ ë‚˜ì—´
    # 2. tail -n +$((MAX_BACKUPS + 1)) : ìƒìœ„ Nê°œë¥¼ ê±´ë„ˆë›°ê³  ê·¸ ì´í›„(ì˜¤ë˜ëœ ê²ƒë“¤)ë§Œ ì¶œë ¥
    # 3. xargs -r podman image rm : ì¶œë ¥ëœ ì˜¤ë˜ëœ ì´ë¯¸ì§€ë“¤ì„ ì‚­ì œ (ëª©ë¡ì´ ì—†ìœ¼ë©´ ì‹¤í–‰ ì•ˆ í•¨)
    
    podman images --sort created --format "{{.Repository}}:{{.Tag}}" \
    | grep "^${BACKUP_REPO}:" \
    | tail -n +$((MAX_BACKUPS + 1)) \
    | xargs -r podman image rm
    
    # ì‚­ì œ ì‘ì—… í›„ ê²°ê³¼ ë©”ì‹œì§€ (ì„ íƒ ì‚¬í•­)
    # ì‚­ì œëœ ì´ë¯¸ì§€ê°€ ì—†ë‹¤ë©´ ìœ„ ëª…ë ¹ì–´ê°€ ì¡°ìš©íˆ ë„˜ì–´ê°‘ë‹ˆë‹¤.
}

# ---------------------------------------------------------
# í•¨ìˆ˜: ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€ì—ì„œ .desktop íŒŒì¼ì„ ì°¾ì•„ ìë™ Export
# ---------------------------------------------------------
auto_export_apps() {
    local pkg_name="$1"
    echo "ğŸ” Checking for GUI applications in '$pkg_name'..."

    # ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ ì‹¤í–‰í•  ìŠ¤í¬ë¦½íŠ¸
    # 1. pacman -Qlq: íŒ¨í‚¤ì§€ê°€ ì„¤ì¹˜í•œ íŒŒì¼ ëª©ë¡ ì¡°íšŒ (Quiet mode)
    # 2. grep: .desktop íŒŒì¼ë§Œ í•„í„°ë§ (/usr/share/applications/ ê²½ë¡œ)
    # 3. while read: ë°œê²¬ëœ íŒŒì¼ë§ˆë‹¤ distrobox-export ì‹¤í–‰
    
    distrobox-enter "$CONTAINER_NAME" -- bash -c '
        target_pkg="$1"
        
        # íŒ¨í‚¤ì§€ íŒŒì¼ ëª©ë¡ ì¡°íšŒ
        if pacman -Qi "$target_pkg" > /dev/null 2>&1; then
            pacman -Qlq "$target_pkg" | grep -E "^/usr/share/applications/.*\.desktop$" | while read -r file; do
                if [ -f "$file" ]; then
                    app_name=$(basename "$file" .desktop)
                    echo "ğŸš€ Auto-exporting: $app_name"
                    distrobox-export --app "$app_name"
                fi
            done
        fi
    ' _ "$pkg_name"
}

if [ "$action" == "init" ]; then
    echo "ğŸ›  Initializing dpm environment..."
    
    # 1. ì•„ì¹˜ ë¦¬ëˆ…ìŠ¤ ì»¨í…Œì´ë„ˆ ìƒì„±
    distrobox-create --name $CONTAINER_NAME --image docker.io/library/archlinux:latest --yes
    
    # 2. í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜ (git, base-devel, yay ì„¤ì¹˜ë¥¼ ìœ„í•œ ì¤€ë¹„)
    echo "ğŸ“¦ Setting up AUR helper (yay)..."
    distrobox-enter $CONTAINER_NAME -- sudo pacman -Syu --noconfirm base-devel git
    
    # 3. yay ì„¤ì¹˜ (ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ ì‹¤í–‰)
    distrobox-enter $CONTAINER_NAME -- bash -c "git clone https://aur.archlinux.org/yay-bin.git && cd yay-bin && makepkg -si --noconfirm && cd .. && rm -rf yay-bin"
    
    echo "âœ¨ Initialization complete! You can now use 'dpm install <package>'."
    exit 0
fi

if [ "$action" == "self-update" ]; then
    echo "ğŸ”„ Updating dpm..."
    sudo curl -fsSL https://raw.githubusercontent.com/hanch2396/dpm/main/dpm -o /usr/local/bin/dpm
    sudo chmod +x /usr/local/bin/dpm
    echo "âœ… Updated to the latest version."
    exit 0
fi

if [ "$action" == "install" ]; then
    if [ -z "$package" ]; then
        echo "âŒ Error: Package name required for install."
        exit 1
    fi
    CMD="yay -S $package --noconfirm"
    LOG_MSG="ğŸ“¦ Installing package: $package"

elif [ "$action" == "upgrade" ]; then
    # ì‹œìŠ¤í…œ ì „ì²´ ì—…ë°ì´íŠ¸ (Archì˜ í‘œì¤€ ë°©ì‹: -Syu)
    CMD="yay -Syu --noconfirm"
    LOG_MSG="ğŸ”„ Upgrading entire system..."

else
    # ê·¸ ì™¸ ëª…ë ¹ì–´(remove, search ë“±)ëŠ” ìŠ¤ëƒ…ìƒ· ì—†ì´ íŒ¨ìŠ¤ìŠ¤ë£¨í•˜ê±°ë‚˜ ë³„ë„ ì²˜ë¦¬
    distrobox-enter "$CONTAINER_NAME" -- yay "$@"
    exit 0
fi

# ---------------------------------------------------------
# ìŠ¤ëƒ…ìƒ· ë° ì‹¤í–‰ ë¡œì§ (installê³¼ upgrade ëª¨ë‘ ì ìš©)
# ---------------------------------------------------------

# 1. ìŠ¤ëƒ…ìƒ· ìƒì„±
TIMESTAMP=$(date +%Y%m%d%H%M%S)
NEW_TAG="${BACKUP_REPO}:${TIMESTAMP}"

echo "ğŸ“¸ Creating snapshot before changes: $NEW_TAG"
podman commit "$CONTAINER_NAME" "$NEW_TAG" > /dev/null

if [ $? -ne 0 ]; then
    echo "âŒ Snapshot failed. Aborting."
    exit 1
fi

# 2. ì˜¤ë˜ëœ ìŠ¤ëƒ…ìƒ· ì •ë¦¬
cleanup_old_backups

# 3. ì‹¤ì œ ëª…ë ¹ì–´ ì‹¤í–‰ (install ë˜ëŠ” upgrade)
echo "$LOG_MSG"
distrobox-enter "$CONTAINER_NAME" -- $CMD

# 4. ê²°ê³¼ í™•ì¸ ë° ë¡¤ë°±
if [ $? -eq 0 ]; then
    echo "âœ… Success!"

    if [ "$action" == "install" ]; then
        auto_export_apps "$package"
    fi

else
    echo "âš ï¸ Operation failed!"
    echo "ğŸ”„ Rolling back to snapshot ($NEW_TAG)..."
    
    distrobox-stop "$CONTAINER_NAME" --yes
    distrobox-rm "$CONTAINER_NAME" --force
    distrobox-create --name "$CONTAINER_NAME" --image "$NEW_TAG" --yes
    
    echo "âœ… Rollback completed."
fi
