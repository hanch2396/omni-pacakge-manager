#!/bin/bash

# --- ì„¤ì • ---
CONTAINER_NAME="om-arch" # Distrobox ì»¨í…Œì´ë„ˆ ì´ë¦„

action=$1

CMD=""
LOG_MSG=""

# ---------------------------------------------------------
# í•¨ìˆ˜: ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€ì—ì„œ .desktop íŒŒì¼ì„ ì°¾ì•„ ìë™ Export
# ---------------------------------------------------------
auto_export_apps() {
    local pkg_name="$1"
    echo "ğŸ” Checking for GUI applications in '$pkg_name'..."

    # ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ ì‹¤í–‰í•  ìŠ¤í¬ë¦½íŠ¸
    # 1. pacman -Qlq: íŒ¨í‚¤ì§€ê°€ ì„¤ì¹˜í•œ íŒŒì¼ ëª©ë¡ ì¡°íšŒ (Quiet mode)
    # 2. grep: .desktop íŒŒì¼ë§Œ í•„í„°ë§ (/usr/share/applications/ ê²½ë¡œ)
    # 3. while read: ë°œê²¬ëœ íŒŒì¼ë§ˆë‹¤ distrobox-export ì‹¤í–‰
    
    distrobox-enter "$CONTAINER_NAME" -- bash <<EOF
        # íŒ¨í‚¤ì§€ ì´ë¦„ ë³€ìˆ˜ ì„¤ì • (í˜¸ìŠ¤íŠ¸ì˜ $pkg_name ê°’ì´ ì—¬ê¸°ì— ë“¤ì–´ê°)
        TARGET="$pkg_name"
        
        # pacman ì¿¼ë¦¬ ì‹¤í–‰
        pacman -Qlq "\$TARGET" 2>/dev/null | grep -E '^/usr/share/applications/.*\.desktop$' | while read -r file; do
            # íŒŒì¼ì´ ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
            if [ -f "\$file" ]; then
                # app=\$(basename "\$file" .desktop)
                echo "ğŸš€ Auto-exporting: \$file"
                distrobox-export --app "\$file"
            fi
        done
EOF
}

auto_export_bins() {
    local pkg_name="$1"
    echo "ğŸ” Checking for binaries in '$pkg_name'..."

    # ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ ì‹¤í–‰í•  ìŠ¤í¬ë¦½íŠ¸
    # 1. pacman -Qlq: íŒ¨í‚¤ì§€ íŒŒì¼ ëª©ë¡ ì¡°íšŒ
    # 2. grep: /usr/bin/ ê²½ë¡œì˜ íŒŒì¼ë§Œ í•„í„°ë§
    # 3. while read: ë°œê²¬ëœ ì‹¤í–‰ íŒŒì¼ë§ˆë‹¤ distrobox-export --bin ì‹¤í–‰
    
    distrobox-enter "$CONTAINER_NAME" -- bash <<EOF
        TARGET="$pkg_name"
        
        # pacman ì¿¼ë¦¬ ì‹¤í–‰ (/usr/bin/ ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” íŒŒì¼ ê²€ìƒ‰)
        pacman -Qlq "\$TARGET" 2>/dev/null | grep -E '^/usr/bin/' | while read -r file; do
            # 1. íŒŒì¼ì´ ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ”ì§€ (-f)
            # 2. ì‹¤í–‰ ê°€ëŠ¥í•œ íŒŒì¼ì¸ì§€ (-x) í™•ì¸ (ë¼ì´ë¸ŒëŸ¬ë¦¬ë‚˜ ë¬¸ì„œ ì œì™¸)
            if [ -f "\$file" ] && [ -x "\$file" ]; then
                echo "ğŸš€ Auto-exporting binary: \$file"
                
                # --bin ì˜µì…˜ ì‚¬ìš©, í˜¸ìŠ¤íŠ¸ì˜ ~/.local/bin ê²½ë¡œë¡œ ë‚´ë³´ëƒ„
                distrobox-export --bin "\$file"
            fi
        done
EOF
}

auto_remove_exported_apps() {
    local pkg_name="$1"
    echo "ğŸ” Checking for GUI applications in '$pkg_name'..."

    # ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ ì‹¤í–‰í•  ìŠ¤í¬ë¦½íŠ¸
    # 1. pacman -Qlq: íŒ¨í‚¤ì§€ê°€ ì„¤ì¹˜í•œ íŒŒì¼ ëª©ë¡ ì¡°íšŒ (Quiet mode)
    # 2. grep: .desktop íŒŒì¼ë§Œ í•„í„°ë§ (/usr/share/applications/ ê²½ë¡œ)
    # 3. while read: ë°œê²¬ëœ íŒŒì¼ë§ˆë‹¤ distrobox-export ì‹¤í–‰
    
    distrobox-enter "$CONTAINER_NAME" -- bash <<EOF
        # íŒ¨í‚¤ì§€ ì´ë¦„ ë³€ìˆ˜ ì„¤ì • (í˜¸ìŠ¤íŠ¸ì˜ $pkg_name ê°’ì´ ì—¬ê¸°ì— ë“¤ì–´ê°)
        TARGET="$pkg_name"
        
        # pacman ì¿¼ë¦¬ ì‹¤í–‰
        pacman -Qlq "\$TARGET" 2>/dev/null | grep -E '^/usr/share/applications/.*\.desktop$' | while read -r file; do
            # íŒŒì¼ì´ ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
            if [ -f "\$file" ]; then
                echo "ğŸ—‘ï¸  Un-exporting: \$file"
                
                # í•µì‹¬ ë³€ê²½ ì‚¬í•­: --delete ì˜µì…˜ ì¶”ê°€
                # ì´ ëª…ë ¹ì´ í˜¸ìŠ¤íŠ¸ì˜ ~/.local/share/applications/ ì—ì„œ 
                # í•´ë‹¹ ì»¨í…Œì´ë„ˆì™€ ì—°ê´€ëœ .desktop íŒŒì¼ì„ ì°¾ì•„ ì‚­ì œí•©ë‹ˆë‹¤.
                distrobox-export --app "\$file" --delete
            fi
        done
EOF
}

auto_remove_exported_bins() {
    local pkg_name="$1"
    echo "ğŸ” Checking for binaries in '$pkg_name'..."

    distrobox-enter "$CONTAINER_NAME" -- bash <<EOF
        TARGET="$pkg_name"
        
        pacman -Qlq "\$TARGET" 2>/dev/null | grep -E '^/usr/bin/' | while read -r file; do
            if [ -f "\$file" ] && [ -x "\$file" ]; then
                echo "ğŸ—‘ï¸  Un-exporting binary: \$file"
                # --delete ì˜µì…˜ìœ¼ë¡œ ì—°ê²° í•´ì œ
                distrobox-export --bin "\$file" --delete
            fi
        done
EOF
}

if [ "$action" == "init" ]; then
    echo "ğŸ›  Initializing om environment..."
    
    # 1. ì•„ì¹˜ ë¦¬ëˆ…ìŠ¤ ì»¨í…Œì´ë„ˆ ìƒì„±
    distrobox-create --name $CONTAINER_NAME --image docker.io/library/archlinux:latest --yes

    distrobox-enter $CONTAINER_NAME -- true # ì´ˆê¸° ì„¤ì •
    
    # 2. ì‹œìŠ¤í…œ ì„¤ì • (ë¡œì¼€ì¼, Multilib, ë³‘ë ¬ ë‹¤ìš´ë¡œë“œ)
    echo "âš™ï¸  Configuring system..."
    
    distrobox-enter $CONTAINER_NAME -- sudo bash <<EOF
        # --- 1) ë¡œì¼€ì¼ ì„¤ì • ---
        sed -i 's/^#en_US.UTF-8 UTF-8/en_US.UTF-8 UTF-8/' /etc/locale.gen
        
        HOST_LANG="$LANG"
        if [ -n "\$HOST_LANG" ]; then
            echo "   -> Detected host locale: \$HOST_LANG"
            CLEAN_LANG=\$(echo "\$HOST_LANG" | sed 's/\./\\\./')
            sed -i "s/^#\$CLEAN_LANG/\$CLEAN_LANG/" /etc/locale.gen
        fi
        
        locale-gen

        # --- 2) Multilib í™œì„±í™” ---
        echo "   -> Enabling multilib repository..."
        
        # pacman.confì— [multilib]ì´ë¼ëŠ” ê¸€ìê°€ ìˆëŠ”ì§€ í™•ì¸
        if grep -q "^\[multilib\]" /etc/pacman.conf; then
            echo "      Found existing section. Uncommenting..."
            sed -i '/\[multilib\]/,/Include/s/^#//' /etc/pacman.conf
        else
            echo "      Section missing. Appending to file..."
            # íŒŒì¼ ëì— [multilib] ì„¤ì • ì¶”ê°€
            echo "" >> /etc/pacman.conf
            echo "[multilib]" >> /etc/pacman.conf
            echo "Include = /etc/pacman.d/mirrorlist" >> /etc/pacman.conf
        fi

        # --- 3) ë³‘ë ¬ ë‹¤ìš´ë¡œë“œ í™œì„±í™” (ì†ë„ í–¥ìƒ) ---
        echo "   -> Setting ParallelDownloads to 10..."
        # ParallelDownloads = 5  <-- ì´ ì¤„ì„ ì°¾ì•„ì„œ ParallelDownloads = 10 ìœ¼ë¡œ ë³€ê²½
        sed -i 's/^ParallelDownloads.*/ParallelDownloads = 10/' /etc/pacman.conf

        # ì„¤ì •ì´ ì˜ ë˜ì—ˆëŠ”ì§€ í™•ì¸ìš© (ë¡œê·¸ ì¶œë ¥)
        echo "   -> Verifying pacman.conf changes:"
        grep -E "^\[multilib\]|^ParallelDownloads" /etc/pacman.conf
EOF

    # 3. ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸ ë° í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜
    # Multilibì´ í™œì„±í™”ë˜ì—ˆìœ¼ë¯€ë¡œ -Syu ì‹¤í–‰ ì‹œ multilib DBë„ í•¨ê»˜ ë™ê¸°í™”ë©ë‹ˆë‹¤.
    echo "ğŸ“¦ Setting up base packages and updating..."
    distrobox-enter $CONTAINER_NAME -- sudo pacman -Syu --noconfirm base-devel git

    # 4. yay ì„¤ì¹˜
    echo "ğŸ“¦ Setting up AUR helper (yay)..."
    distrobox-enter $CONTAINER_NAME -- bash -c "git clone https://aur.archlinux.org/yay-bin.git && cd yay-bin && makepkg -si --noconfirm && cd .. && rm -rf yay-bin"

    echo "âœ¨ Initialization complete! You can now use 'om install <package>'."
    exit 0
fi

if [ "$action" == "self-update" ]; then
    echo "ğŸ”„ Updating om..."
    curl -fsSL https://raw.githubusercontent.com/hanch2396/omni-pacakge-manager/main/om -o ${HOME}/.local/bin/om
    chmod +x ${HOME}/.local/bin/om
    echo "âœ… Updated to the latest version."
    exit 0
fi

shift  # ì²« ë²ˆì§¸ ì¸ì(install, upgrade ë“±)ë¥¼ ëª©ë¡ì—ì„œ ì œê±°
       # ì´ì œë¶€í„° $1, $2... ëŠ” ëª¨ë‘ íŒ¨í‚¤ì§€ ì´ë¦„ì´ ë©ë‹ˆë‹¤. ($@)

if [ "$action" == "install" ]; then
    # ì¸ìê°€ ì—†ìœ¼ë©´ ì—ëŸ¬
    if [ $# -eq 0 ]; then
        echo "âŒ Error: Package name(s) required."
        exit 1
    fi
    
    # $* : ë‚¨ì€ ëª¨ë“  ì¸ìë¥¼ ê³µë°±ìœ¼ë¡œ ì—°ê²° (ì˜ˆ: "pkg1 pkg2 pkg3")
    CMD="yay -S $* --noconfirm"
    LOG_MSG="ğŸ“¦ Installing packages: $*"

elif [ "$action" == "remove" ]; then
     if [ $# -eq 0 ]; then
        echo "âŒ Error: Package name(s) required."
        exit 1
    fi

    for pkg in "$@"; do
        auto_remove_exported_apps "$pkg"
        auto_remove_exported_bins "$pkg"
    done

    CMD="yay -Rns $* --noconfirm"
    LOG_MSG="ğŸ—‘ Removing packages: $*"

elif [ "$action" == "update" ]; then
    # ì‹œìŠ¤í…œ ì „ì²´ ì—…ë°ì´íŠ¸ (Archì˜ í‘œì¤€ ë°©ì‹: -Syu)
    CMD="yay -Syu --noconfirm"
    LOG_MSG="ğŸ”„ Upgrading entire system..."

elif [ "$action" == "enter" ]; then
    # ì‚¬ìš©ë²• 1: dpm enter          (ë‹¨ìˆœ ì…¸ ì§„ì…)
    # ì‚¬ìš©ë²• 2: dpm enter [ëª…ë ¹ì–´] (ì»¨í…Œì´ë„ˆ ì•ˆì—ì„œ íŠ¹ì • ëª…ë ¹ì–´ ì‹¤í–‰)

    if [ $# -eq 0 ]; then
        # ì¶”ê°€ ì¸ìê°€ ì—†ìœ¼ë©´ ê·¸ëƒ¥ ì…¸ë¡œ ì§„ì…
        echo "ğŸš€ Entering interactive shell in '$CONTAINER_NAME'..."
        echo "Type 'exit' to return to host."
        distrobox-enter "$CONTAINER_NAME"
    else
        # ì¶”ê°€ ì¸ìê°€ ìˆìœ¼ë©´ í•´ë‹¹ ëª…ë ¹ì–´ë¥¼ ì»¨í…Œì´ë„ˆ ì•ˆì—ì„œ ì‹¤í–‰
        # -- (ëŒ€ì‹œ ë‘ ê°œ)ëŠ” distrobox ì˜µì…˜ê³¼ ì‹¤í–‰í•  ëª…ë ¹ì–´ë¥¼ êµ¬ë¶„í•©ë‹ˆë‹¤.
        echo "ğŸš€ Executing in '$CONTAINER_NAME': $*"
        distrobox-enter "$CONTAINER_NAME" -- "$@"
    fi
    
    # ì‹¤í–‰ í›„ ì¢…ë£Œ ì½”ë“œ ì „ë‹¬
    exit $?

elif [ "$action" == "export" ]; then

    TYPE="$1"
    NAME="$2"

    # ìˆ˜ë™ Export ê¸°ëŠ¥
    if [ "$TYPE" == "--app" ]; then
        if [ -z "$NAME" ]; then
            echo "âŒ App name required."
            exit 1
        fi
        distrobox-enter "$CONTAINER_NAME" -- distrobox-export --app "$NAME"
    elif [ "$TYPE" == "--bin" ]; then
        if [ -z "$NAME" ]; then
            echo "âŒ Valid binary path required."
            exit 1
        fi
        distrobox-enter "$CONTAINER_NAME" -- distrobox-export --bin "$NAME"
    else
        echo "âŒ Error: Unknown option"
        echo "Usage: om export [--app|--bin] ..."
        exit 1
    fi
    
    exit $?

elif [ "$action" == "unexport" ]; then

    TYPE="$1"
    NAME="$2"

    # ìˆ˜ë™ unexport ê¸°ëŠ¥
    if [ "$TYPE" == "--app" ]; then
        if [ -z "$NAME" ]; then
            echo "âŒ App name required."
            exit 1
        fi
        distrobox-enter "$CONTAINER_NAME" -- distrobox-export --app "$NAME" --delete
    elif [ "$TYPE" == "--bin" ]; then
        if [ -z "$NAME" ]; then
            echo "âŒ Valid binary path required."
            exit 1
        fi
        distrobox-enter "$CONTAINER_NAME" -- distrobox-export --bin "$NAME" --delete
    else
        echo "âŒ Error: Unknown option"
        echo "Usage: om unexport [--app|--bin] ..."
        exit 1
    fi

    exit $?

elif [ "$action" == "clean" ]; then
    CMD="yay -Scc --noconfirm &> /dev/null && yay -Qdtq | yay -Rns --noconfirm - 2> /dev/null"
    LOG_MSG="ğŸ§¹ Cleaning system garbage (Orphans & Cache)..."

else
    # ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹ì–´ ì²˜ë¦¬ (ì˜¤íƒ€ ë°©ì§€)
    echo "âŒ Unknown command: '$action'"
    echo "   Did you mean 'install'?"
    echo "Usage: om [init|self-update|install|remove|update|enter|export|unexport|clean] ..."
    exit 1
fi

# ---------------------------------------------------------
# ì‹¤í–‰ ë¡œì§
# ---------------------------------------------------------

# 1. ì»¨í…Œì´ë„ˆ ì¡´ì¬ í™•ì¸ (ì•ˆì „ì„ ìœ„í•´)
if ! podman container exists "$CONTAINER_NAME"; then
    echo "âŒ Container '$CONTAINER_NAME' not found."
    echo "   Please run 'om init' first."
    exit 1
fi

# 2. ëª…ë ¹ì–´ ì‹¤í–‰ (ì„¤ì¹˜ ì‹œë„)
echo "$LOG_MSG"
distrobox-enter "$CONTAINER_NAME" -- bash -c "$CMD"
EXIT_CODE=$?

# 3. ê²°ê³¼ì— ë”°ë¥¸ ë¶„ê¸° ì²˜ë¦¬
if [ $EXIT_CODE -eq 0 ]; then
    echo "âœ… Success!"
    
    # ì„±ê³µí–ˆìœ¼ë¯€ë¡œ ìë™ Export ì‹¤í–‰
    if [ "$action" == "install" ]; then
        for pkg in "$@"; do
            auto_export_apps "$pkg"
            auto_export_bins "$pkg"
        done
    fi

else
    echo "âš ï¸  Operation failed!"

    if [ "$action" == "clean" ]; then
        echo "âœ¨ Likely cause: No orphan packages found. Your system is already clean!"
    fi

    exit 1
fi
